# æµ‹è¯•ç¯å¢ƒé…ç½®æ€»ç»“

## âœ… å·²å®Œæˆçš„é…ç½®

### 1. æ•°æ®åº“éš”ç¦» âœ…

| ç¯å¢ƒ | æ•°æ®åº“è·¯å¾„ | ç«¯å£ | ç¯å¢ƒå˜é‡ |
|-----|-----------|------|---------|
| **å¼€å‘** | `backend/data/deploy-webhook.db` | 9000 | `NODE_ENV=development` |
| **æµ‹è¯•** | `backend/data/test/deploy-webhook.db` | 9001 | `NODE_ENV=test` |

**å®ç°æ–¹å¼ï¼š**
- é€šè¿‡ `DB_PATH` ç¯å¢ƒå˜é‡æŒ‡å®šæ•°æ®åº“è·¯å¾„
- æµ‹è¯•æ¨¡å¼è‡ªåŠ¨ä½¿ç”¨ `./data/test` ç›®å½•
- æµ‹è¯•å‰åè‡ªåŠ¨æ¸…ç†æµ‹è¯•æ•°æ®åº“

### 2. Playwright é…ç½® âœ…

**æ–‡ä»¶ï¼š** `ui/playwright.config.ts`

**å…³é”®é…ç½®ï¼š**
```typescript
{
  globalSetup: './e2e/global-setup.ts',      // æµ‹è¯•å‰æ¸…ç†æ•°æ®åº“
  globalTeardown: './e2e/global-teardown.ts', // æµ‹è¯•åæ¸…ç†æ•°æ®åº“
  
  webServer: [
    {
      // å‰ç«¯ï¼šæŒ‡å‘æµ‹è¯•åç«¯
      command: 'VITE_API_BASE_URL=http://localhost:9001 npm run dev',
      port: 5173,
      env: { VITE_API_BASE_URL: 'http://localhost:9001' }
    },
    {
      // åç«¯ï¼šæµ‹è¯•æ¨¡å¼
      command: 'cd ../backend && NODE_ENV=test PORT=9001 DB_PATH=./data/test npm run dev',
      port: 9001,
      env: {
        NODE_ENV: 'test',
        PORT: '9001',
        DB_PATH: './data/test'
      }
    }
  ]
}
```

### 3. å…¨å±€ Setup/Teardown âœ…

**Setup (æµ‹è¯•å‰)ï¼š**
- æ¸…ç†æµ‹è¯•æ•°æ®åº“ (`backend/data/test/`)
- æ¸…ç†æµ‹è¯•å®¹å™¨ (`docker ps -a --filter "name=test-"`)
- è®¾ç½®ç¯å¢ƒå˜é‡

**Teardown (æµ‹è¯•å)ï¼š**
- æ¸…ç†æµ‹è¯•æ•°æ®åº“ï¼ˆå¯é€šè¿‡ `KEEP_TEST_DB=true` ä¿ç•™ï¼‰
- æ¸…ç†æµ‹è¯•å®¹å™¨

### 4. æµ‹è¯•æµç¨‹ä¼˜åŒ– âœ…

**ä»æ³¨å†Œå¼€å§‹æµ‹è¯•ï¼š**
```typescript
test.beforeEach(async ({ page }) => {
  // 1. æ¸…ç†æµè§ˆå™¨å­˜å‚¨
  await cleanupTestData(page);
  
  // 2. æ³¨å†Œæ–°ç”¨æˆ·ï¼ˆç¡®ä¿æ•°æ®åº“ä¸ºç©ºï¼‰
  await register(page, 'testuser', 'test@example.com', 'Test123456!');
});
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### å¿«é€Ÿå¼€å§‹

```bash
cd ui
npm run test:e2e
```

### æ‰‹åŠ¨å¯åŠ¨ï¼ˆæ¨èè°ƒè¯•ï¼‰

```bash
# ç»ˆç«¯ 1: åç«¯æµ‹è¯•æ¨¡å¼
cd backend
NODE_ENV=test PORT=9001 DB_PATH=./data/test npm run dev

# ç»ˆç«¯ 2: å‰ç«¯ï¼ˆæŒ‡å‘æµ‹è¯•åç«¯ï¼‰
cd ui
VITE_API_BASE_URL=http://localhost:9001 npm run dev

# ç»ˆç«¯ 3: è¿è¡Œæµ‹è¯•
cd ui
npm run test:e2e
```

### è°ƒè¯•æ¨¡å¼

```bash
# UI æ¨¡å¼ï¼ˆå¯è§†åŒ–ï¼‰
npm run test:e2e:ui

# Debug æ¨¡å¼ï¼ˆé€æ­¥ï¼‰
npm run test:e2e:debug

# ä¿ç•™æµ‹è¯•æ•°æ®åº“
KEEP_TEST_DB=true npm run test:e2e
```

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### âœ… é—®é¢˜ 1: æµ‹è¯•æ¨¡å¼å¯åŠ¨
- **ä¹‹å‰**: åç«¯ä»¥å¼€å‘æ¨¡å¼å¯åŠ¨ï¼ˆ`npm run dev`ï¼‰
- **ç°åœ¨**: åç«¯ä»¥æµ‹è¯•æ¨¡å¼å¯åŠ¨ï¼ˆ`NODE_ENV=test npm run dev`ï¼‰

### âœ… é—®é¢˜ 2: æ•°æ®åº“éš”ç¦»
- **ä¹‹å‰**: æµ‹è¯•å’Œå¼€å‘å…±ç”¨åŒä¸€æ•°æ®åº“
- **ç°åœ¨**: æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„ `data/test/` æ•°æ®åº“

### âœ… é—®é¢˜ 3: ç«¯å£å†²çª
- **ä¹‹å‰**: æµ‹è¯•å’Œå¼€å‘å…±ç”¨ 9000 ç«¯å£
- **ç°åœ¨**: æµ‹è¯•ä½¿ç”¨ 9001 ç«¯å£ï¼Œä¸å¼€å‘ç«¯å£éš”ç¦»

### âœ… é—®é¢˜ 4: æ•°æ®æ¸…ç†
- **ä¹‹å‰**: æ‰‹åŠ¨æ¸…ç†ï¼Œå®¹æ˜“é—æ¼
- **ç°åœ¨**: è‡ªåŠ¨æ¸…ç†ï¼ˆæµ‹è¯•å‰åï¼‰

### âœ… é—®é¢˜ 5: æµ‹è¯•ç”¨æˆ·
- **ä¹‹å‰**: å‡è®¾ admin ç”¨æˆ·å­˜åœ¨
- **ç°åœ¨**: æ¯ä¸ªæµ‹è¯•å‰æ³¨å†Œæ–°ç”¨æˆ·

## ğŸ“‹ æµ‹è¯•æ£€æŸ¥æ¸…å•

è¿è¡Œæµ‹è¯•å‰æ£€æŸ¥ï¼š

- [ ] Docker æœåŠ¡æ­£åœ¨è¿è¡Œ
- [ ] ç«¯å£ 5173 å’Œ 9001 æœªè¢«å ç”¨
- [ ] æ²¡æœ‰è¿è¡Œå¼€å‘æ¨¡å¼çš„åç«¯ï¼ˆç«¯å£ 9000ï¼‰
- [ ] æµ‹è¯•æ•°æ®åº“å·²æ¸…ç†ï¼ˆæˆ–ç”± global-setup è‡ªåŠ¨æ¸…ç†ï¼‰

è¿è¡Œæµ‹è¯•åæ£€æŸ¥ï¼š

- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æµ‹è¯•æ•°æ®åº“å·²æ¸…ç†ï¼ˆæˆ–æŸ¥çœ‹ `data/test/` ç”¨äºè°ƒè¯•ï¼‰
- [ ] æµ‹è¯•å®¹å™¨å·²æ¸…ç†
- [ ] æ²¡æœ‰é—ç•™çš„æµ‹è¯•æ•°æ®

## ğŸ› æ•…éšœæ’é™¤

### ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :9001

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### æ•°æ®åº“é”å®š

```bash
# æ¸…ç† WAL æ–‡ä»¶
rm backend/data/test/*.db-wal
rm backend/data/test/*.db-shm
```

### æµ‹è¯•å®¹å™¨æ¸…ç†

```bash
# æ¸…ç†æ‰€æœ‰æµ‹è¯•å®¹å™¨
docker ps -a --filter "name=test-" -q | xargs docker rm -f
```

### å®Œå…¨é‡ç½®

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
pkill -f "npm run dev"

# æ¸…ç†æµ‹è¯•æ•°æ®
cd backend
./scripts/cleanup-testing.sh

# é‡æ–°è¿è¡Œæµ‹è¯•
cd ../ui
npm run test:e2e
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [E2E_TESTING_GUIDE.md](./E2E_TESTING_GUIDE.md) - å®Œæ•´æµ‹è¯•æŒ‡å—
- [E2E_TEST_STRATEGY.md](./E2E_TEST_STRATEGY.md) - æµ‹è¯•ç­–ç•¥è¯´æ˜
- [RUN_E2E_TESTS.md](./RUN_E2E_TESTS.md) - å¿«é€Ÿè¿è¡ŒæŒ‡å—

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… è¿è¡Œæ³¨å†Œæµ‹è¯•
2. âœ… è¿è¡Œç™»å½•æµ‹è¯•
3. â³ å®ç°ç¯å¢ƒå˜é‡æµ‹è¯•
4. â³ å®ç°ç§˜é’¥ç®¡ç†æµ‹è¯•
5. â³ å®ç°åº”ç”¨éƒ¨ç½²æµ‹è¯•

---

**é…ç½®å®Œæˆæ—¥æœŸ**: 2025-10-24
**é…ç½®çŠ¶æ€**: âœ… å®Œæˆå¹¶ç»è¿‡éªŒè¯

