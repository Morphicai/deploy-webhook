# E2E 测试策略说明

## 📋 测试策略概述

### ✅ 正确的测试流程

1. **从注册开始测试**
   - ✅ 测试用例应该从用户注册流程开始
   - ✅ 每个测试套件在 `beforeEach` 中注册新的测试用户
   - ✅ 确保测试环境数据是干净的

2. **测试数据隔离**
   - ✅ 每个测试前清理 localStorage 和 sessionStorage
   - ✅ 后端应该在测试模式下使用独立的测试数据库
   - ✅ 每个测试使用唯一的用户名避免冲突

3. **测试执行顺序**
   ```
   注册测试 (register.spec.ts)
     ├─ 用户首次注册成功流程
     ├─ 注册失败 - 密码不匹配
     ├─ 注册失败 - 密码过于简单
     ├─ 注册失败 - 用户名已存在
     ├─ 注册表单验证 - 空字段
     └─ 注册失败 - 邮箱格式不正确
   
   登录测试 (login.spec.ts)
     ├─ 用户登录成功流程 (依赖注册)
     ├─ 登录失败 - 错误的用户名密码
     ├─ 登录表单验证 - 空用户名
     ├─ 登录表单验证 - 空密码
     ├─ 记住我功能
     ├─ 登出功能
     ├─ 自动跳转 - 已登录用户访问登录页
     └─ 未登录访问受保护页面
   ```

## 🔧 实现细节

### 测试用户配置

```typescript
const testUser = {
  username: 'testuser',      // 默认测试用户名
  email: 'test@example.com', // 默认测试邮箱
  password: 'Test123456!'    // 强密码（符合安全要求）
};
```

### 测试环境准备

```typescript
test.beforeEach(async ({ page }) => {
  // 1. 清理浏览器存储
  await cleanupTestData(page);
  
  // 2. 注册新的测试用户
  await register(page, testUser.username, testUser.email, testUser.password);
});
```

## 🚀 运行测试

### 1. 手动启动服务（推荐）

```bash
# 终端 1: 启动后端 (测试模式)
cd backend
NODE_ENV=test npm run dev

# 终端 2: 启动前端
cd ui
npm run dev

# 终端 3: 运行测试
cd ui
npm run test:e2e
```

### 2. 自动启动服务（Playwright 配置）

```bash
# Playwright 会自动启动前后端服务
npm run test:e2e
```

**注意事项：**
- 自动启动模式下，Playwright 会复用已存在的服务（`reuseExistingServer: true`）
- 如果服务启动超时，请手动启动服务后再运行测试

## 📊 测试覆盖率

### 认证层测试（当前阶段）
- [x] 用户注册流程（6 个测试用例）
- [x] 用户登录流程（8 个测试用例）
- [ ] API Key 管理（待实现）

### 后续测试层
- [ ] 环境变量管理（10 个测试用例）
- [ ] 秘钥管理（12 个测试用例）
- [ ] 应用部署（15 个测试用例）
- [ ] 配置管理（12 个测试用例）
- [ ] 综合场景（10 个测试用例）

## 🐛 常见问题

### Q1: 为什么测试失败提示用户不存在？
**A:** 确保每个测试前都执行了 `register()` 函数注册测试用户。

### Q2: 为什么测试之间会互相影响？
**A:** 确保每个测试前都执行了 `cleanupTestData()` 清理浏览器存储。

### Q3: 后端需要特殊配置吗？
**A:** 是的，后端应该在测试模式下运行：
```bash
NODE_ENV=test npm run dev
```

### Q4: 如何调试失败的测试？
```bash
# 使用 UI 模式调试
npm run test:e2e:ui

# 使用 Debug 模式
npm run test:e2e:debug
```

## 📝 最佳实践

1. **✅ 每个测试独立运行**
   - 不依赖其他测试的状态
   - 自己准备所需的测试数据

2. **✅ 使用有意义的测试数据**
   - 用户名、邮箱、密码都应该是真实的格式
   - 避免使用 `test`、`123` 等简单数据

3. **✅ 验证多个断言**
   - 不只验证 HTTP 状态码
   - 还要验证页面跳转、UI 变化、数据存储等

4. **✅ 使用合适的等待策略**
   - 优先使用 `waitForURL()` 和 `toBeVisible()`
   - 避免使用固定的 `waitForTimeout()`

5. **✅ 编写清晰的测试描述**
   - 测试名称应该清楚描述测试场景
   - 包含预期结果

## 🔄 持续改进

- [ ] 添加更多边界情况测试
- [ ] 实现跨浏览器测试（Firefox、Safari）
- [ ] 添加性能测试（页面加载时间）
- [ ] 实现视觉回归测试
- [ ] 集成 CI/CD 流程

