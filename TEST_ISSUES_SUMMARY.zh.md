# æµ‹è¯•å¤±è´¥é—®é¢˜æ€»ç»“

## ğŸ“Š æµ‹è¯•ç»“æœæ¦‚è§ˆ

- æ€»æµ‹è¯•æ•°ï¼š**44** ä¸ª
- å¤±è´¥æ•°ï¼š**16** ä¸ª
- å¤±è´¥ç‡ï¼š**36%**
- æµ‹è¯•æ–‡ä»¶ï¼š3 ä¸ªï¼ˆsecrets.test.ts, auth.test.ts, åŠå…¶ä»–ï¼‰

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜æ±‡æ€»

### 1. ç¯å¢ƒå˜é‡ API é—®é¢˜ (7ä¸ªå¤±è´¥)

**é—®é¢˜1ï¼šHTTP çŠ¶æ€ç é”™è¯¯**
- åˆ›å»ºç¯å¢ƒå˜é‡è¿”å› `200` è€Œä¸æ˜¯ `201 Created`
- å½±å“æµ‹è¯•ï¼šåˆ›å»ºå…¨å±€/é¡¹ç›®ç¯å¢ƒå˜é‡ã€upsert æ“ä½œ

**é—®é¢˜2ï¼šè·¯ç”±ä¸å­˜åœ¨**
- æµ‹è¯•æœŸæœ›ï¼š`PUT /api/env/:id` å’Œ `DELETE /api/env/:id`
- å®é™…æƒ…å†µï¼šåªæœ‰ `DELETE /api/env?scope=xxx&key=xxx` ï¼ˆä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼‰
- å½±å“æµ‹è¯•ï¼šæ›´æ–°ç¯å¢ƒå˜é‡ã€åˆ é™¤ç¯å¢ƒå˜é‡

**é—®é¢˜3ï¼šå‚æ•°ä¸åŒ¹é…**
- æµ‹è¯•ä½¿ç”¨ï¼š`projectName`ï¼ˆå­—ç¬¦ä¸²ï¼‰
- API æœŸæœ›ï¼š`projectId`ï¼ˆæ•°å­—ï¼‰
- å½±å“æµ‹è¯•ï¼šåˆ›å»ºé¡¹ç›®ç¯å¢ƒå˜é‡ã€ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§æµ‹è¯•

**ä½ç½®ï¼š**
```
backend/src/routes/env.ts:74-77    - POST è¿”å› 200
backend/src/routes/env.ts:120-129  - DELETE ä½¿ç”¨æŸ¥è¯¢å‚æ•°
backend/src/services/envStore.ts:5-10 - æœŸæœ› projectId
```

---

### 2. ç§˜é’¥ API é—®é¢˜ (2ä¸ªå¤±è´¥)

**é—®é¢˜1ï¼šå“åº”æ•°æ®ç¼ºå¤± ID**
- `createSecret` è¿”å›çš„æ•°æ®ä¸­ `data.id` ä¸º `undefined`
- å¯¼è‡´åç»­åˆ é™¤æ“ä½œå¤±è´¥
- å½±å“æµ‹è¯•ï¼šåˆ é™¤ç§˜é’¥

**é—®é¢˜2ï¼šé”™è¯¯çŠ¶æ€ç **
- åˆ›å»ºé‡å¤ç§˜é’¥åç§°è¿”å› `500` è€Œä¸æ˜¯ `400 Bad Request`
- åŸå› ï¼šæŠ›å‡ºæ™®é€š `Error` è€Œä¸æ˜¯è‡ªå®šä¹‰éªŒè¯é”™è¯¯
- å½±å“æµ‹è¯•ï¼šæ‹’ç»é‡å¤ç§˜é’¥åç§°

**ä½ç½®ï¼š**
```
backend/src/services/database.ts - createSecret å‡½æ•°éœ€æ£€æŸ¥
backend/src/services/secretStore.ts:27-30 - é”™è¯¯å¤„ç†
```

---

### 3. ç”¨æˆ·æ³¨å†Œé—®é¢˜ (3ä¸ªå¤±è´¥)

**é—®é¢˜ï¼šéªŒè¯é€»è¾‘è¢«è·³è¿‡**
- ç¬¬ä¸€ä¸ªç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œ`hasAnyUser()` è¿”å› `true`
- æ‰€æœ‰åç»­æ³¨å†Œè¯·æ±‚ç›´æ¥è¿”å› `403 Forbidden`ï¼ˆä¸å…è®¸æ³¨å†Œï¼‰
- è¾“å…¥éªŒè¯ï¼ˆé‚®ç®±æ ¼å¼ã€å¯†ç é•¿åº¦ï¼‰æ°¸è¿œä¸ä¼šæ‰§è¡Œ
- å½±å“æµ‹è¯•ï¼šé‡å¤é‚®ç®±ã€æ— æ•ˆé‚®ç®±æ ¼å¼ã€å¯†ç è¿‡çŸ­

**ä½ç½®ï¼š**
```
backend/src/routes/auth.ts:17-19
```

**é€»è¾‘æµç¨‹ï¼š**
```
1. æ£€æŸ¥ hasAnyUser() â†’ å¦‚æœ trueï¼Œè¿”å› 403 âŒ
2. éªŒè¯è¾“å…¥ â† æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
3. åˆ›å»ºç”¨æˆ·
```

**åº”è¯¥æ”¹ä¸ºï¼š**
```
1. éªŒè¯è¾“å…¥ï¼ˆé‚®ç®±æ ¼å¼ã€å¯†ç é•¿åº¦ï¼‰
2. æ£€æŸ¥ hasAnyUser()
3. åˆ›å»ºç”¨æˆ·
```

---

### 4. API Key è®¤è¯é—®é¢˜ (2ä¸ªå¤±è´¥)

**é—®é¢˜ï¼šè®¤è¯é€»è¾‘é”™è¯¯**

**åŸå› 1ï¼šæµ‹è¯•å®¢æˆ·ç«¯è®¾ç½®é”™è¯¯**
```typescript
// tests/helpers/apiClient.ts:38-40
if (this.authToken) {
  req = req.set('x-admin-token', this.authToken);  // âŒ æ€»æ˜¯ç”¨ x-admin-token
}
```

å½“ä½¿ç”¨ API Key æ—¶ï¼Œåº”è¯¥è®¾ç½®ä¸º `Authorization: Bearer <api-key>` æˆ– `X-API-Key`ã€‚

**åŸå› 2ï¼šAPI Key æ ¼å¼è¦æ±‚è¿‡ä¸¥**
```typescript
// backend/src/middleware/apiKeyAuth.ts:30-32
if (token.startsWith('dw_')) {  // âŒ å¿…é¡»ä»¥ dw_ å¼€å¤´
  return token;
}
```

**åŸå› 3ï¼šè®¤è¯é¡ºåºé—®é¢˜**
- `requireAnyAuth` å…ˆæ£€æŸ¥ admin token
- å¦‚æœé€šè¿‡ `x-admin-token` ä¼ é€’ API Keyï¼Œä¼šå…ˆè¢«å½“ä½œ admin token éªŒè¯
- Admin token éªŒè¯å¤±è´¥åï¼Œä¸ä¼šç»§ç»­å°è¯• API Key éªŒè¯

**ä½ç½®ï¼š**
```
backend/tests/helpers/apiClient.ts:38-40
backend/src/middleware/apiKeyAuth.ts:30-32, 133-169
```

---

## ğŸ› ï¸ ä¿®å¤å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### P0 - å¿…é¡»ç«‹å³ä¿®å¤

1. **ç¯å¢ƒå˜é‡ API è·¯ç”±ç»Ÿä¸€**
   ```typescript
   // æ–¹æ¡ˆ Aï¼šæ·»åŠ  RESTful è·¯ç”±
   router.put('/:id', ...)    // æ›´æ–°
   router.delete('/:id', ...) // åˆ é™¤
   
   // æ–¹æ¡ˆ Bï¼šæ›´æ–°æµ‹è¯•ä½¿ç”¨ç°æœ‰è·¯ç”±
   client.delete('/api/env?scope=global&key=TEST_KEY')
   ```

2. **ä¿®å¤ç¯å¢ƒå˜é‡å‚æ•°**
   - åœ¨è·¯ç”±å±‚å°† `projectName` è½¬æ¢ä¸º `projectId`
   - æˆ–ç»Ÿä¸€ä½¿ç”¨ `projectId`

3. **ä¿®å¤ API Key è®¤è¯**
   - ä¿®æ”¹ `ApiClient` æ ¹æ® token ç±»å‹è®¾ç½®ä¸åŒçš„è¯·æ±‚å¤´
   - æ”¹è¿› `requireAnyAuth` çš„è®¤è¯é¡ºåº

### P1 - åº”è¯¥å°½å¿«ä¿®å¤

4. **ä¿®å¤ç”¨æˆ·æ³¨å†Œé€»è¾‘**
   ```typescript
   router.post('/register', async (req, res) => {
     try {
       // 1. å…ˆéªŒè¯è¾“å…¥
       const validatedData = validateUserInput(req.body);
       
       // 2. å†æ£€æŸ¥æ˜¯å¦å…è®¸æ³¨å†Œ
       if (hasAnyUser()) {
         return res.status(403).json({ success: false, error: 'Registration disabled' });
       }
       
       // 3. åˆ›å»ºç”¨æˆ·
       const created = await createUser(validatedData);
       res.status(201).json({ success: true, data: { user: { id: created.id, email: created.email } } });
     } catch (error) {
       const fail = buildErrorResponse(error);
       res.status(fail.code ?? 400).json(fail);
     }
   });
   ```

5. **ä¿®å¤ç§˜é’¥åˆ›å»ºè¿”å›å€¼**
   - æ£€æŸ¥ `database.ts` ä¸­çš„ `createSecret` å‡½æ•°
   - ç¡®ä¿è¿”å›åŒ…å« `id` çš„å®Œæ•´è®°å½•

6. **æ”¹è¿›é”™è¯¯å¤„ç†**
   ```typescript
   // secretStore.ts
   if (getSecretByName(parsed.name)) {
     throw { code: 400, message: `Secret with name ${parsed.name} already exists` };
   }
   ```

### P2 - ä¼˜åŒ–æ”¹è¿›

7. **ç»Ÿä¸€ HTTP çŠ¶æ€ç **
   ```typescript
   // env.ts:74
   res.status(201).json({ success: true, data: entry });  // æ”¹ä¸º 201
   ```

---

## ğŸ“‹ å¿«é€Ÿä¿®å¤æ£€æŸ¥æ¸…å•

```
[ ] ç¯å¢ƒå˜é‡ POST è¿”å› 201 è€Œä¸æ˜¯ 200
[ ] æ·»åŠ ç¯å¢ƒå˜é‡ PUT /:id å’Œ DELETE /:id è·¯ç”±
[ ] ç¯å¢ƒå˜é‡ API æ”¯æŒ projectName å‚æ•°ï¼ˆè‡ªåŠ¨è½¬æ¢ä¸º projectIdï¼‰
[ ] ApiClient æ ¹æ® token ç±»å‹è®¾ç½®æ­£ç¡®çš„è¯·æ±‚å¤´
[ ] requireAnyAuth æ”¹è¿›è®¤è¯é¡ºåºå’Œé€»è¾‘
[ ] ç§˜é’¥åˆ›å»ºè¿”å›å®Œæ•´æ•°æ®ï¼ˆåŒ…å« idï¼‰
[ ] é‡å¤ç§˜é’¥è¿”å› 400 è€Œä¸æ˜¯ 500
[ ] ç”¨æˆ·æ³¨å†Œå…ˆéªŒè¯è¾“å…¥å†æ£€æŸ¥ hasAnyUser()
[ ] æ‰€æœ‰é”™è¯¯å“åº”åŒ…å« success: false
```

---

## ğŸ¯ æ ¹æœ¬åŸå› 

1. **API è®¾è®¡ä¸ä¸€è‡´**
   - æœ‰äº›ç«¯ç‚¹ç”¨è·¯å¾„å‚æ•°ï¼ˆ`:id`ï¼‰ï¼Œæœ‰äº›ç”¨æŸ¥è¯¢å‚æ•°
   - å‚æ•°å‘½åä¸ç»Ÿä¸€ï¼ˆ`projectId` vs `projectName`ï¼‰
   - HTTP çŠ¶æ€ç ä½¿ç”¨ä¸è§„èŒƒ

2. **æµ‹è¯•ä¸å®ç°è„±èŠ‚**
   - æµ‹è¯•æœŸæœ›çš„ API è¡Œä¸ºä¸å®é™…å®ç°ä¸åŒ¹é…
   - å¯èƒ½æ˜¯å…ˆå†™æµ‹è¯•åæ”¹ä»£ç ï¼Œæˆ–å…ˆå†™ä»£ç åè¡¥æµ‹è¯•

3. **è®¤è¯ä¸­é—´ä»¶è¿‡äºå¤æ‚**
   - æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆAdmin Tokenã€JWTã€API Keyã€Webhook Secretï¼‰
   - è®¤è¯é¡ºåºå’Œåˆ¤æ–­é€»è¾‘æœ‰æ¼æ´

4. **ä¸šåŠ¡é€»è¾‘é¡ºåºé—®é¢˜**
   - ç”¨æˆ·æ³¨å†Œåœ¨éªŒè¯è¾“å…¥ä¹‹å‰å°±æ£€æŸ¥æƒé™
   - å¯¼è‡´éªŒè¯é€»è¾‘æ°¸è¿œä¸ä¼šæ‰§è¡Œ

---

## ğŸ“ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### æºä»£ç æ–‡ä»¶
- âœï¸ `backend/src/routes/env.ts` - æ·»åŠ è·¯ç”±ã€ä¿®æ”¹çŠ¶æ€ç 
- âœï¸ `backend/src/routes/auth.ts` - è°ƒæ•´æ³¨å†Œé€»è¾‘é¡ºåº
- âœï¸ `backend/src/middleware/apiKeyAuth.ts` - ä¿®å¤è®¤è¯é€»è¾‘
- âœï¸ `backend/src/services/secretStore.ts` - æ”¹è¿›é”™è¯¯å¤„ç†
- ğŸ” `backend/src/services/database.ts` - æ£€æŸ¥ç§˜é’¥åˆ›å»ºè¿”å›å€¼

### æµ‹è¯•æ–‡ä»¶
- âœï¸ `backend/tests/helpers/apiClient.ts` - ä¿®å¤ API Key è®¾ç½®
- ğŸ” `backend/tests/integration/secrets.test.ts` - å¯èƒ½éœ€è¦è°ƒæ•´å‚æ•°
- ğŸ” `backend/tests/integration/auth.test.ts` - å¯èƒ½éœ€è¦è°ƒæ•´æµ‹è¯•ç­–ç•¥

---

## ğŸ’¡ æ¨èä¿®å¤ç­–ç•¥

é‡‡ç”¨**æ··åˆç­–ç•¥**ï¼š

1. **ä¿®å¤æ˜æ˜¾é”™è¯¯**ï¼ˆä»£ç  bugï¼‰
   - HTTP çŠ¶æ€ç é”™è¯¯
   - è®¤è¯é€»è¾‘ bug
   - é”™è¯¯å¤„ç†ä¸å½“

2. **ç»Ÿä¸€è®¾è®¡æ ‡å‡†**ï¼ˆAPI è§„èŒƒï¼‰
   - ç¡®å®šè·¯ç”±é£æ ¼ï¼ˆRESTful è¿˜æ˜¯æŸ¥è¯¢å‚æ•°ï¼‰
   - ç»Ÿä¸€å‚æ•°å‘½åè§„èŒƒ
   - ç›¸åº”æ›´æ–°æµ‹è¯•æˆ–ä»£ç 

3. **æ·»åŠ æ–‡æ¡£**
   - ç¼–å†™ API æ–‡æ¡£ï¼ˆOpenAPI/Swaggerï¼‰
   - æ˜ç¡®è®¤è¯æ–¹å¼å’Œä¼˜å…ˆçº§
   - è§„èŒƒé”™è¯¯ç å’Œå“åº”æ ¼å¼

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³ä¿®å¤ P0 é—®é¢˜**ï¼ˆä¼°è®¡ 2-4 å°æ—¶ï¼‰
2. **è¿è¡Œæµ‹è¯•éªŒè¯**
3. **ä¿®å¤ P1 é—®é¢˜**ï¼ˆä¼°è®¡ 2-3 å°æ—¶ï¼‰
4. **å†æ¬¡è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶**
5. **æ›´æ–° API æ–‡æ¡£**
6. **è€ƒè™‘æ·»åŠ é›†æˆæµ‹è¯•è¦†ç›–è¾¹ç•Œæƒ…å†µ**

