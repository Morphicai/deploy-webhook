# æ•°æ®æ¨¡å‹ V2 - å…³é”®å·¥ä½œæµç¨‹

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµç¨‹å¯¹æ¯”

### æ—§ç‰ˆæµç¨‹ï¼ˆV1ï¼‰- ä¸å¤Ÿå®‰å…¨

```
å¤–éƒ¨ Webhook
     â†“
éªŒè¯ webhook secret
     â†“
ä¼ å…¥å®Œæ•´é…ç½®ï¼š
- name (ä»»æ„)
- image
- version  
- port
- containerPort
     â†“
ç›´æ¥éƒ¨ç½²å®¹å™¨
     â†“
è‡ªåŠ¨åˆ›å»ºåº”ç”¨è®°å½• (upsert)
```

**é—®é¢˜**ï¼š
- âŒ å¯ä»¥éƒ¨ç½²ä»»æ„åº”ç”¨
- âŒ å¯ä»¥å ç”¨ä»»æ„ç«¯å£
- âŒ ç§˜é’¥ç®¡ç†æ··ä¹±
- âŒ æ— æ³•å®¡è®¡

---

### æ–°ç‰ˆæµç¨‹ï¼ˆV2ï¼‰- å®‰å…¨å¯æ§

```
1. å‡†å¤‡é˜¶æ®µï¼ˆåœ¨ç®¡ç†åå°ï¼‰
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†å‘˜é¢„å…ˆæ³¨å†Œåº”ç”¨                    â”‚
â”‚ - é…ç½®é•œåƒã€ç«¯å£                      â”‚
â”‚ - ç”Ÿæˆ webhook token (whk_xxx)       â”‚
â”‚ - é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯å¼•ç”¨ç§˜é’¥ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
2. éƒ¨ç½²é˜¶æ®µï¼ˆCI/CD è§¦å‘ï¼‰
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤–éƒ¨ Webhook                         â”‚
â”‚ POST /webhook/deploy                 â”‚
â”‚ {                                    â”‚
â”‚   "applicationId": 123,              â”‚
â”‚   "version": "v1.2.3",               â”‚
â”‚   "token": "whk_xxx"                 â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
3. éªŒè¯é˜¶æ®µ
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ“ åº”ç”¨æ˜¯å¦å­˜åœ¨ï¼Ÿ                      â”‚
â”‚ âœ“ Webhook æ˜¯å¦å¯ç”¨ï¼Ÿ                  â”‚
â”‚ âœ“ Token æ˜¯å¦åŒ¹é…ï¼Ÿ                    â”‚
â”‚ âœ“ ç‰ˆæœ¬å·æ˜¯å¦æœ‰æ•ˆï¼Ÿ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
4. éƒ¨ç½²é˜¶æ®µ
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨é¢„æ³¨å†Œçš„é…ç½®ï¼š                    â”‚
â”‚ - é•œåƒåç§°ï¼ˆä»åº”ç”¨è®°å½•ï¼‰               â”‚
â”‚ - ç«¯å£æ˜ å°„ï¼ˆä»åº”ç”¨è®°å½•ï¼‰               â”‚
â”‚ - ç¯å¢ƒå˜é‡ï¼ˆè§£æç§˜é’¥å¼•ç”¨ï¼‰             â”‚
â”‚ - ä»“åº“è®¤è¯ï¼ˆä» repositoryï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
5. è®°å½•é˜¶æ®µ
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®°å½•éƒ¨ç½²æ—¥å¿—                          â”‚
â”‚ - è§¦å‘æ¥æº: webhook                   â”‚
â”‚ - è§¦å‘IP                              â”‚
â”‚ - éƒ¨ç½²çŠ¶æ€                            â”‚
â”‚ - é”™è¯¯ä¿¡æ¯                            â”‚
â”‚ - è€—æ—¶ç»Ÿè®¡                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ç§˜é’¥ç®¡ç†æµç¨‹

### åœºæ™¯1ï¼šæ‰‹åŠ¨ç®¡ç†ç§˜é’¥

```
ç®¡ç†å‘˜æ“ä½œ
     â†“
1. åˆ›å»ºç§˜é’¥åˆ†ç»„
   "production-db"
     â†“
2. æ·»åŠ ç§˜é’¥åˆ°åˆ†ç»„
   DATABASE_URL = "postgresql://..."
   REDIS_URL = "redis://..."
   â†“ (åŠ å¯†å­˜å‚¨)
   value = "iv:tag:encrypted_data"
     â†“
3. åœ¨ç¯å¢ƒå˜é‡ä¸­å¼•ç”¨
   Project: myapp
   - NODE_ENV = "production"        [çº¯æ–‡æœ¬]
   - DATABASE_URL = "@secret:1"     [å¼•ç”¨ç§˜é’¥]
     â†“
4. éƒ¨ç½²æ—¶è‡ªåŠ¨è§£æ
   è¯»å– env è¡¨ â†’ å‘ç° secret_ref
              â†“
          è¯»å– secrets è¡¨
              â†“
          è§£å¯†ç§˜é’¥å€¼
              â†“
   æ³¨å…¥åˆ°å®¹å™¨ç¯å¢ƒå˜é‡
```

### åœºæ™¯2ï¼šä» Infisical è‡ªåŠ¨åŒæ­¥

```
1. é…ç½® Infisical Provider
   â†“
   {
     type: "infisical",
     config: {
       clientId: "xxx",
       clientSecret: "yyy",
       projectId: "zzz"
     },
     autoSync: true
   }
     â†“
2. åˆ›å»ºå…³è”åˆ†ç»„
   â†“
   {
     name: "infisical-prod",
     providerId: 1,
     autoSync: true
   }
     â†“
3. æ‰‹åŠ¨/è‡ªåŠ¨è§¦å‘åŒæ­¥
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Infisical API                        â”‚
â”‚ GET /api/v3/secrets                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   è¿”å›ç§˜é’¥åˆ—è¡¨
   [
     { key: "DATABASE_URL", value: "..." },
     { key: "API_KEY", value: "..." }
   ]
     â†“
4. ä¿å­˜åˆ°æœ¬åœ°
   â†“
   FOR EACH secret:
     - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
     - åŠ å¯† value
     - ä¿å­˜åˆ° secrets è¡¨
     - æ ‡è®° source = "synced"
     - è®°å½• providerReference
     â†“
5. æ›´æ–°åŒæ­¥çŠ¶æ€
   â†“
   secret_providers.last_sync_at = NOW
   secret_providers.last_sync_status = "success"
     â†“
6. è®°å½•åŒæ­¥æ—¥å¿—
   â†“
   secret_syncs è¡¨æ’å…¥è®°å½•
```

### åœºæ™¯3ï¼šæ‰¹é‡å¯¼å…¥ç§˜é’¥åˆ°é¡¹ç›®

```
ç®¡ç†å‘˜åœ¨ UI æ“ä½œ
     â†“
é€‰æ‹©åˆ†ç»„: "production-db"
é€‰æ‹©é¡¹ç›®: "myapp"
ç‚¹å‡»: [å¯¼å…¥åˆ°é¡¹ç›®]
     â†“
åç«¯å¤„ç†
     â†“
1. è¯»å–åˆ†ç»„å†…æ‰€æœ‰ç§˜é’¥
   â†“
   SELECT * FROM secrets 
   WHERE group_id = 1
     â†“
2. ä¸ºæ¯ä¸ªç§˜é’¥åˆ›å»ºç¯å¢ƒå˜é‡å¼•ç”¨
   â†“
   FOR EACH secret:
     INSERT INTO environment_variables
     (scope, project_id, key, value, value_type, secret_id)
     VALUES 
     ('project', 5, 'DATABASE_URL', '@secret:1', 'secret_ref', 1)
     â†“
3. è¿”å›å¯¼å…¥ç»“æœ
   â†“
   {
     success: true,
     imported: 5,
     skipped: 0,
     secrets: [...]
   }
```

---

## ğŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹ç¤ºä¾‹

### GitHub Actions + Webhook Deploy

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build and Push Image
        run: |
          docker build -t mycompany/myapp:${{ steps.version.outputs.VERSION }} .
          docker push mycompany/myapp:${{ steps.version.outputs.VERSION }}
      
      - name: Trigger Deployment
        run: |
          curl -X POST https://deploy.example.com/webhook/deploy \
            -H "Content-Type: application/json" \
            -d '{
              "applicationId": 123,
              "version": "${{ steps.version.outputs.VERSION }}",
              "token": "${{ secrets.DEPLOY_WEBHOOK_TOKEN }}"
            }'
```

**æœåŠ¡å™¨ç«¯å¤„ç†æµç¨‹**ï¼š

```
1. æ¥æ”¶ Webhook è¯·æ±‚
   â†“
   POST /webhook/deploy
   {
     applicationId: 123,
     version: "v1.2.3",
     token: "whk_abc..."
   }
     â†“
2. æŸ¥è¯¢åº”ç”¨
   â†“
   SELECT * FROM applications WHERE id = 123
   â†“
   è¿”å›:
   {
     id: 123,
     name: "myapp",
     image: "mycompany/myapp",
     webhookEnabled: 1,
     webhookToken: "whk_abc...",
     repositoryId: 1,
     ports: [{host: 8080, container: 80}]
   }
     â†“
3. éªŒè¯ Webhook Token
   â†“
   app.webhookToken === provided token ?
   âœ“ åŒ¹é…
     â†“
4. åˆ›å»ºéƒ¨ç½²æ—¥å¿—
   â†“
   INSERT INTO deployment_logs
   (application_id, version, status, trigger_type)
   VALUES (123, "v1.2.3", "pending", "webhook")
   â†“
   è¿”å› deploymentId = "uuid-xxx"
     â†“
5. æ„å»ºç¯å¢ƒå˜é‡
   â†“
   SELECT * FROM environment_variables 
   WHERE scope = 'global' 
      OR (scope = 'project' AND project_id = 123)
   â†“
   FOR EACH env_var:
     IF value_type == 'secret_ref':
       â†“
       è¯»å–ç§˜é’¥: SELECT * FROM secrets WHERE id = secret_id
       â†“
       è§£å¯†: decryptSecret(secret.value)
       â†“
       ç»“æœ: { key: value }
     â†“
   æœ€ç»ˆç¯å¢ƒå˜é‡:
   {
     NODE_ENV: "production",
     DATABASE_URL: "postgresql://...",  // å·²è§£å¯†
     REDIS_URL: "redis://...",          // å·²è§£å¯†
     API_KEY: "sk_live_..."             // å·²è§£å¯†
   }
     â†“
6. è·å–é•œåƒä»“åº“è®¤è¯
   â†“
   SELECT * FROM repositories WHERE id = 1
   â†“
   è¿”å›:
   {
     registry: "https://index.docker.io/v1/",
     authType: "username-password",
     username: "myuser",
     password: "mypass"
   }
     â†“
7. æ‹‰å–é•œåƒ
   â†“
   docker pull mycompany/myapp:v1.2.3
   ä½¿ç”¨è®¤è¯ä¿¡æ¯: myuser:mypass
     â†“
8. åœæ­¢æ—§å®¹å™¨
   â†“
   docker stop myapp
   docker rm myapp
     â†“
9. å¯åŠ¨æ–°å®¹å™¨
   â†“
   docker run -d \
     --name myapp \
     -p 8080:80 \
     -e NODE_ENV=production \
     -e DATABASE_URL=postgresql://... \
     -e REDIS_URL=redis://... \
     -e API_KEY=sk_live_... \
     --restart unless-stopped \
     mycompany/myapp:v1.2.3
     â†“
10. æ›´æ–°åº”ç”¨çŠ¶æ€
    â†“
    UPDATE applications 
    SET version = "v1.2.3",
        status = "running",
        last_deployed_at = NOW()
    WHERE id = 123
      â†“
11. æ›´æ–°éƒ¨ç½²æ—¥å¿—
    â†“
    UPDATE deployment_logs
    SET status = "success",
        completed_at = NOW(),
        duration_ms = 15234
    WHERE deployment_id = "uuid-xxx"
      â†“
12. è¿”å›å“åº”
    â†“
    {
      success: true,
      deploymentId: "uuid-xxx",
      application: {
        id: 123,
        name: "myapp",
        version: "v1.2.3"
      },
      message: "Deployment completed successfully"
    }
```

---

## ğŸ”’ å®‰å…¨å±‚çº§

### è®¤è¯å±‚çº§ï¼ˆä»å¼±åˆ°å¼ºï¼‰

```
Level 1: Webhook Secretï¼ˆå·²åºŸå¼ƒï¼‰
â”œâ”€â”€ å…¨å±€ secret
â”œâ”€â”€ æ‰€æœ‰åº”ç”¨å…±äº«
â””â”€â”€ âŒ æ³„éœ²åå½±å“æ‰€æœ‰åº”ç”¨

Level 2: API Key
â”œâ”€â”€ dw_xxxxx æ ¼å¼
â”œâ”€â”€ å¯è®¾ç½®æƒé™ï¼ˆfull/deploy/readonlyï¼‰
â”œâ”€â”€ å¯è®¾ç½®è¿‡æœŸæ—¶é—´
â””â”€â”€ âš ï¸ æ³„éœ²åå½±å“å¤šä¸ªåº”ç”¨

Level 3: Application Webhook Tokenï¼ˆæ¨èï¼‰
â”œâ”€â”€ whk_xxxxx æ ¼å¼
â”œâ”€â”€ æ¯ä¸ªåº”ç”¨ç‹¬ç«‹
â”œâ”€â”€ åªèƒ½éƒ¨ç½²ç‰¹å®šåº”ç”¨
â””â”€â”€ âœ… æ³„éœ²åå½±å“æœ€å°

Level 4: JWT Tokenï¼ˆç®¡ç†å‘˜ï¼‰
â”œâ”€â”€ ç”¨æˆ·ç™»å½•åè·å¾—
â”œâ”€â”€ çŸ­æœŸæœ‰æ•ˆ
â”œâ”€â”€ å¯ä»¥æ‰§è¡Œæ‰€æœ‰æ“ä½œ
â””â”€â”€ âœ… æœ€é«˜æƒé™
```

### æ•°æ®åŠ å¯†å±‚çº§

```
ä¼ è¾“å±‚
â”œâ”€â”€ HTTPS/TLS
â””â”€â”€ é˜²æ­¢ä¸­é—´äººæ”»å‡»

å­˜å‚¨å±‚
â”œâ”€â”€ ç§˜é’¥åŠ å¯†ï¼ˆAES-256-GCMï¼‰
â”‚   â”œâ”€â”€ value å­—æ®µåŠ å¯†å­˜å‚¨
â”‚   â”œâ”€â”€ æŸ¥çœ‹éœ€è¦è§£å¯†
â”‚   â””â”€â”€ ç¯å¢ƒå˜é‡æ³¨å…¥æ—¶è‡ªåŠ¨è§£å¯†
â”‚
â”œâ”€â”€ å¯†ç å“ˆå¸Œï¼ˆbcryptï¼‰
â”‚   â”œâ”€â”€ users.password_hash
â”‚   â”œâ”€â”€ api_keys.key_hash
â”‚   â””â”€â”€ ä¸å¯é€†åŠ å¯†
â”‚
â””â”€â”€ Token å­˜å‚¨ï¼ˆæ˜æ–‡ï¼‰
    â”œâ”€â”€ applications.webhook_token
    â””â”€â”€ éœ€è¦å®Œå…¨åŒ¹é…éªŒè¯
```

---

## ğŸ“Š æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æ“ä½œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                         â”‚
       â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§˜é’¥ç®¡ç†     â”‚                        â”‚  åº”ç”¨ç®¡ç†     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åˆ›å»ºåˆ†ç»„    â”‚                        â”‚ â€¢ æ³¨å†Œåº”ç”¨    â”‚
â”‚ â€¢ æ·»åŠ ç§˜é’¥    â”‚                        â”‚ â€¢ é…ç½®ç«¯å£    â”‚
â”‚ â€¢ é…ç½®åŒæ­¥    â”‚                        â”‚ â€¢ ç”Ÿæˆtoken   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                       â”‚
       â”‚ å¼•ç”¨                                  â”‚
       â”‚                                       â”‚
       â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¯å¢ƒå˜é‡ç®¡ç†                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åˆ›å»ºå˜é‡                                        â”‚
â”‚ â€¢ å¼•ç”¨ç§˜é’¥ï¼ˆ@secret:idï¼‰                         â”‚
â”‚ â€¢ å…³è”é¡¹ç›®                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ ä½¿ç”¨
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                éƒ¨ç½²æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Webhook éªŒè¯                                   â”‚
â”‚ 2. è¯»å–åº”ç”¨é…ç½®                                   â”‚
â”‚ 3. è§£æç¯å¢ƒå˜é‡ï¼ˆè§£å¯†ç§˜é’¥ï¼‰                       â”‚
â”‚ 4. æ‹‰å–é•œåƒï¼ˆä½¿ç”¨ä»“åº“è®¤è¯ï¼‰                       â”‚
â”‚ 5. å¯åŠ¨å®¹å™¨                                       â”‚
â”‚ 6. è®°å½•æ—¥å¿—                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¿è¡Œä¸­çš„å®¹å™¨                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¯å¢ƒå˜é‡:                                         â”‚
â”‚ - NODE_ENV=production                            â”‚
â”‚ - DATABASE_URL=postgresql://... (å·²è§£å¯†)          â”‚
â”‚ - API_KEY=sk_live_... (å·²è§£å¯†)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å…³é”®æ”¹è¿›æ€»ç»“

### 1. ç§˜é’¥ç®¡ç†

**V1 (æ—§)**:
```
secrets è¡¨
â”œâ”€â”€ name: "prod-db"
â”œâ”€â”€ provider: "infisical"
â”œâ”€â”€ reference: "/path/to/secret"
â””â”€â”€ âŒ æ²¡æœ‰å­˜å‚¨å®é™…å€¼
```

**V2 (æ–°)**:
```
secret_groups è¡¨ (åˆ†ç»„)
â”œâ”€â”€ production-db
â”œâ”€â”€ staging-api
â””â”€â”€ common

secrets è¡¨ (ç§˜é’¥)
â”œâ”€â”€ name: "DATABASE_URL"
â”œâ”€â”€ groupId: 1
â”œâ”€â”€ value: "encrypted_value"  âœ… åŠ å¯†å­˜å‚¨
â”œâ”€â”€ source: "manual" | "synced"
â””â”€â”€ providerId: 1 (å¦‚æœæ˜¯åŒæ­¥çš„)
```

### 2. Webhook éƒ¨ç½²

**V1 (æ—§)**:
```bash
POST /deploy
{
  "name": "ä»»æ„åç§°",      # âŒ ä¸å®‰å…¨
  "image": "ä»»æ„é•œåƒ",     # âŒ ä¸å®‰å…¨
  "port": "ä»»æ„ç«¯å£",      # âŒ ä¸å®‰å…¨
  "secret": "å…¨å±€secret"   # âŒ æ³„éœ²å½±å“å¤§
}
```

**V2 (æ–°)**:
```bash
POST /webhook/deploy
{
  "applicationId": 123,        # âœ… å¿…é¡»é¢„æ³¨å†Œ
  "version": "v1.2.3",         # âœ… åªèƒ½æ”¹ç‰ˆæœ¬
  "token": "whk_app_specific"  # âœ… åº”ç”¨ä¸“ç”¨
}
```

### 3. ç¯å¢ƒå˜é‡

**V1 (æ—§)**:
```typescript
{
  key: "DATABASE_URL",
  value: "postgresql://..."  // âŒ æ˜æ–‡å­˜å‚¨
}
```

**V2 (æ–°)**:
```typescript
{
  key: "DATABASE_URL",
  value: "@secret:1",        // âœ… å¼•ç”¨ç§˜é’¥
  valueType: "secret_ref",
  secretId: 1
}

// éƒ¨ç½²æ—¶è‡ªåŠ¨è§£æï¼š
// @secret:1 â†’ ä» secrets è¡¨è¯»å– â†’ è§£å¯† â†’ æ³¨å…¥å®¹å™¨
```

### 4. å®¡è®¡æ—¥å¿—

**V1 (æ—§)**:
```
âŒ æ²¡æœ‰éƒ¨ç½²æ—¥å¿—
```

**V2 (æ–°)**:
```typescript
deployment_logs è¡¨
â”œâ”€â”€ applicationId: 123
â”œâ”€â”€ version: "v1.2.3"
â”œâ”€â”€ deploymentId: "uuid"
â”œâ”€â”€ triggerType: "webhook"
â”œâ”€â”€ triggerSource: "192.168.1.100"
â”œâ”€â”€ status: "success"
â”œâ”€â”€ startedAt: "2025-10-23T10:30:00Z"
â”œâ”€â”€ completedAt: "2025-10-23T10:30:15Z"
â””â”€â”€ durationMs: 15234

âœ… å®Œæ•´çš„éƒ¨ç½²å†å²
âœ… å¯è¿½æº¯è§¦å‘æ¥æº
âœ… æ€§èƒ½ç»Ÿè®¡
```

---

## ğŸš€ å®æ–½å»ºè®®

### é˜¶æ®µ1ï¼šæ ¸å¿ƒè¡¨ç»“æ„ï¼ˆ1-2å¤©ï¼‰
- [ ] åˆ›å»º `secret_groups` è¡¨
- [ ] é‡æ„ `secrets` è¡¨
- [ ] ä¿®æ”¹ `applications` è¡¨ï¼ˆæ·»åŠ  webhook å­—æ®µï¼‰
- [ ] åˆ›å»º `deployment_logs` è¡¨
- [ ] ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬

### é˜¶æ®µ2ï¼šç§˜é’¥ç®¡ç†ï¼ˆ2-3å¤©ï¼‰
- [ ] å®ç°ç§˜é’¥åŠ å¯†/è§£å¯†
- [ ] å®ç°ç§˜é’¥åˆ†ç»„ CRUD
- [ ] å®ç°ç§˜é’¥ CRUD
- [ ] å®ç°ç§˜é’¥åŒæ­¥é€»è¾‘
- [ ] UIï¼šç§˜é’¥ç®¡ç†é¡µé¢

### é˜¶æ®µ3ï¼šç¯å¢ƒå˜é‡å¢å¼ºï¼ˆ1-2å¤©ï¼‰
- [ ] æ”¯æŒç§˜é’¥å¼•ç”¨
- [ ] å®ç°è§£æé€»è¾‘
- [ ] UIï¼šç¯å¢ƒå˜é‡ç¼–è¾‘å™¨æ”¹è¿›
- [ ] UIï¼šæ‰¹é‡å¯¼å…¥åˆ†ç»„

### é˜¶æ®µ4ï¼šWebhook é‡æ„ï¼ˆ2-3å¤©ï¼‰
- [ ] æ–°å¢ `/webhook/deploy` ç«¯ç‚¹
- [ ] å®ç° token éªŒè¯
- [ ] å®ç°éƒ¨ç½²æ—¥å¿—è®°å½•
- [ ] UIï¼šåº”ç”¨ webhook é…ç½®é¡µé¢
- [ ] UIï¼šéƒ¨ç½²å†å²æŸ¥çœ‹

### é˜¶æ®µ5ï¼šæµ‹è¯•å’Œæ–‡æ¡£ï¼ˆ1-2å¤©ï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] ç”¨æˆ·æŒ‡å—
- [ ] è¿ç§»æŒ‡å—

**æ€»è®¡ï¼š7-12 å¤©å¼€å‘æ—¶é—´**

