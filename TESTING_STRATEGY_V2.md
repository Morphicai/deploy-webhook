# V2 æµ‹è¯•ç­–ç•¥ - ä»åŸºç¡€åˆ°ä¸Šå±‚

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

**å½“å‰çŠ¶æ€ï¼š** 31 ä¸ªæµ‹è¯•é€šè¿‡ï¼Œ40 ä¸ªæµ‹è¯•å¤±è´¥  
**æµ‹è¯•æ–‡ä»¶ï¼š** 4 ä¸ªé›†æˆæµ‹è¯•æ–‡ä»¶  
**ç­–ç•¥ï¼š** è‡ªåº•å‘ä¸Šï¼Œé€å±‚æµ‹è¯•ä¿®å¤

---

## ğŸ—ï¸ æµ‹è¯•æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 4 å±‚ï¼šä¸šåŠ¡åº”ç”¨å±‚                 â”‚
â”‚  â”œâ”€ deploy.test.ts (éƒ¨ç½²åŠŸèƒ½)       â”‚
â”‚  â””â”€ Webhook éƒ¨ç½²                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 3 å±‚ï¼šä¸šåŠ¡æ•°æ®å±‚                 â”‚
â”‚  â”œâ”€ secrets.test.ts (ç§˜é’¥ç®¡ç†)      â”‚
â”‚  â”œâ”€ deploymentLogs.test.ts (æ—¥å¿—)   â”‚
â”‚  â””â”€ ç¯å¢ƒå˜é‡ç®¡ç†                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 2 å±‚ï¼šè®¤è¯æˆæƒå±‚                 â”‚
â”‚  â””â”€ auth.test.ts (ç”¨æˆ·/API Key)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ 1 å±‚ï¼šåŸºç¡€è®¾æ–½å±‚                 â”‚
â”‚  â”œâ”€ æ•°æ®åº“åˆå§‹åŒ–                    â”‚
â”‚  â”œâ”€ Secret Groups (V2 æ–°å¢)         â”‚
â”‚  â””â”€ åŠ å¯†æœåŠ¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ¨èæµ‹è¯•é¡ºåº

### é˜¶æ®µ 1ï¼šåŸºç¡€è®¾æ–½å±‚ï¼ˆå¿…é¡»å…ˆé€šè¿‡ï¼‰

**ç›®æ ‡ï¼š** ç¡®ä¿æ•°æ®åº“å’ŒåŸºç¡€æœåŠ¡æ­£å¸¸

#### 1.1 æ•°æ®åº“è¡¨ç»“æ„éªŒè¯
- âœ… secret_groups è¡¨
- âœ… secrets è¡¨ï¼ˆV2 ç»“æ„ï¼‰
- âœ… environment_variables è¡¨ï¼ˆV2 ç»“æ„ï¼‰
- âœ… applications è¡¨ï¼ˆåŒ…å« webhook å­—æ®µï¼‰
- âœ… deployment_logs è¡¨

**æµ‹è¯•æ–¹æ³•ï¼š**
```bash
# æ‰‹åŠ¨éªŒè¯æ•°æ®åº“ç»“æ„
cd backend
npm run build
node -e "
const { getDb } = require('./dist/services/database');
const db = getDb();
console.log('Tables:', db.prepare('SELECT name FROM sqlite_master WHERE type=\"table\"').all());
"
```

#### 1.2 Secret Groups åŸºç¡€åŠŸèƒ½
- åˆ›å»ºç§˜é’¥ç»„
- åˆ—å‡ºç§˜é’¥ç»„
- åˆ é™¤ç§˜é’¥ç»„

**å…³é”®ä¾èµ–ï¼š**
- `secretGroupStore.ts`
- æ•°æ®åº“è¡¨ `secret_groups`

---

### é˜¶æ®µ 2ï¼šè®¤è¯æˆæƒå±‚ï¼ˆæ¨èç¬¬äºŒæµ‹è¯•ï¼‰

**æµ‹è¯•æ–‡ä»¶ï¼š** `tests/integration/auth.test.ts`

**æµ‹è¯•å†…å®¹ï¼š**
1. âœ… ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
2. âœ… JWT Token éªŒè¯
3. âœ… API Key åˆ›å»ºå’ŒéªŒè¯
4. âœ… API Key æƒé™æ§åˆ¶

**é¢„æœŸç»“æœï¼š** åº”è¯¥å…¨éƒ¨é€šè¿‡ï¼ˆè®¤è¯æ˜¯æœ€åº•å±‚ï¼Œä¸ä¾èµ–å…¶ä»–æ¨¡å—ï¼‰

**è¿è¡Œå‘½ä»¤ï¼š**
```bash
npm test -- auth.test.ts
```

**å…³é”®ä¾èµ–ï¼š**
- `userStore.ts`
- `apiKeyStore.ts`
- JWT ä¸­é—´ä»¶

---

### é˜¶æ®µ 3ï¼šä¸šåŠ¡æ•°æ®å±‚ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

#### 3.1 ç§˜é’¥ç®¡ç†æµ‹è¯•

**æµ‹è¯•æ–‡ä»¶ï¼š** `tests/integration/secrets.test.ts`

**æ¨¡å—åˆ’åˆ†ï¼š**

**3.1.1 Secret Groupsï¼ˆV2 æ–°åŠŸèƒ½ï¼‰**
- [ ] åˆ›å»ºç§˜é’¥ç»„
- [ ] åˆ—å‡ºç§˜é’¥ç»„
- [ ] æŸ¥è¯¢ç§˜é’¥ç»„è¯¦æƒ…
- [ ] åˆ é™¤ç§˜é’¥ç»„

**3.1.2 Secretsï¼ˆV2 é‡æ„ï¼‰**
- [ ] åˆ›å»ºç§˜é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
- [ ] åˆ—å‡ºç§˜é’¥ï¼ˆå¸¦é¢„è§ˆï¼‰
- [ ] æŸ¥è¯¢ç§˜é’¥ï¼ˆè§£å¯†ï¼‰
- [ ] æ›´æ–°ç§˜é’¥
- [ ] åˆ é™¤ç§˜é’¥
- [ ] æŒ‰ç»„æŸ¥è¯¢ç§˜é’¥

**3.1.3 Environment Variablesï¼ˆV2 å¢å¼ºï¼‰**
- [ ] åˆ›å»ºç¯å¢ƒå˜é‡ï¼ˆçº¯æ–‡æœ¬ï¼‰
- [ ] åˆ›å»ºç¯å¢ƒå˜é‡ï¼ˆå¼•ç”¨ç§˜é’¥ï¼‰âœ¨ V2 æ–°åŠŸèƒ½
- [ ] åˆ—å‡ºç¯å¢ƒå˜é‡
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡
- [ ] åˆ é™¤ç¯å¢ƒå˜é‡
- [ ] Upsert æ“ä½œ
- [ ] ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ï¼ˆå…¨å±€ vs é¡¹ç›®ï¼‰

**3.1.4 Secret Referencesï¼ˆV2 æ–°åŠŸèƒ½ï¼‰**
- [ ] ç¯å¢ƒå˜é‡å¼•ç”¨ç§˜é’¥ âœ¨
- [ ] æŸ¥è¯¢å¼•ç”¨ç§˜é’¥çš„ç¯å¢ƒå˜é‡ âœ¨
- [ ] è§£æç§˜é’¥å¼•ç”¨ âœ¨

**è¿è¡Œå‘½ä»¤ï¼š**
```bash
# å®Œæ•´æµ‹è¯•
npm test -- secrets.test.ts

# åˆ†æ®µæµ‹è¯•
npm test -- secrets.test.ts -t "Secret Groups"
npm test -- secrets.test.ts -t "Secrets Management"
npm test -- secrets.test.ts -t "Environment Variables"
npm test -- secrets.test.ts -t "Secret References"
```

**å…³é”®ä¾èµ–ï¼š**
- `secretGroupStore.ts` âœ¨ V2 æ–°å¢
- `secretStore.ts`ï¼ˆV2 é‡æ„ï¼‰
- `envStore.ts`ï¼ˆV2 é‡æ„ï¼‰
- `encryption.ts`ï¼ˆåŠ å¯†å·¥å…·ï¼‰

**å·²çŸ¥é—®é¢˜ï¼š**
- âŒ ç¯å¢ƒå˜é‡æ›´æ–°/åˆ é™¤ 404 é”™è¯¯
- âŒ Secret åˆ›å»ºè¿”å›æ•°æ®ç»“æ„é—®é¢˜
- âŒ ç¯å¢ƒå˜é‡å¼•ç”¨ç§˜é’¥åŠŸèƒ½æœªå®ç°

---

#### 3.2 éƒ¨ç½²æ—¥å¿—æµ‹è¯•

**æµ‹è¯•æ–‡ä»¶ï¼š** `tests/integration/deploymentLogs.test.ts`

**æµ‹è¯•å†…å®¹ï¼š**
1. [ ] åˆ›å»ºéƒ¨ç½²æ—¥å¿—
2. [ ] æŸ¥è¯¢éƒ¨ç½²æ—¥å¿—ï¼ˆæŒ‰åº”ç”¨ï¼‰
3. [ ] æŸ¥è¯¢éƒ¨ç½²æ—¥å¿—ï¼ˆæŒ‰çŠ¶æ€ï¼‰
4. [ ] æ›´æ–°éƒ¨ç½²æ—¥å¿—çŠ¶æ€
5. [ ] éƒ¨ç½²æ—¥å¿—åˆ†é¡µ

**è¿è¡Œå‘½ä»¤ï¼š**
```bash
npm test -- deploymentLogs.test.ts
```

**å…³é”®ä¾èµ–ï¼š**
- `deploymentLogStore.ts` âœ¨ V2 æ–°å¢
- `applications` è¡¨
- `deployment_logs` è¡¨

---

### é˜¶æ®µ 4ï¼šä¸šåŠ¡åº”ç”¨å±‚ï¼ˆæœ€ä¸Šå±‚ï¼‰

**æµ‹è¯•æ–‡ä»¶ï¼š** `tests/integration/deploy.test.ts`

**æ¨¡å—åˆ’åˆ†ï¼š**

**4.1 åº”ç”¨ç®¡ç†ï¼ˆV2 å¢å¼ºï¼‰**
- [ ] åˆ›å»ºåº”ç”¨
- [ ] æ›´æ–°åº”ç”¨
- [ ] å¯ç”¨/ç¦ç”¨ Webhook âœ¨ V2 æ–°åŠŸèƒ½
- [ ] é‡æ–°ç”Ÿæˆ Webhook Token âœ¨ V2 æ–°åŠŸèƒ½

**4.2 åº”ç”¨éƒ¨ç½²**
- [ ] åŸºç¡€éƒ¨ç½²æµç¨‹
- [ ] ä½¿ç”¨ç¯å¢ƒå˜é‡éƒ¨ç½²
- [ ] ä½¿ç”¨ç§˜é’¥å¼•ç”¨éƒ¨ç½² âœ¨ V2 æ–°åŠŸèƒ½
- [ ] é•œåƒç™½åå•éªŒè¯

**4.3 Webhook éƒ¨ç½²ï¼ˆV2 æ–°åŠŸèƒ½ï¼‰**
- [ ] Webhook éƒ¨ç½²ï¼ˆå¸¦ Token éªŒè¯ï¼‰âœ¨
- [ ] Webhook ç¦ç”¨æ£€æŸ¥ âœ¨
- [ ] éƒ¨ç½²æ—¥å¿—è®°å½• âœ¨

**è¿è¡Œå‘½ä»¤ï¼š**
```bash
# å®Œæ•´æµ‹è¯•
npm test -- deploy.test.ts

# åˆ†æ®µæµ‹è¯•
npm test -- deploy.test.ts -t "Application Management"
npm test -- deploy.test.ts -t "Deployment"
npm test -- deploy.test.ts -t "Webhook"
```

**å…³é”®ä¾èµ–ï¼š**
- `applicationStore.ts`ï¼ˆV2 å¢å¼ºï¼‰
- `deployService.ts`
- `webhookDeploy.ts` âœ¨ V2 æ–°å¢
- `deploymentLogStore.ts` âœ¨ V2 æ–°å¢

---

## ğŸ“ æµ‹è¯•æ‰§è¡Œè®¡åˆ’

### Step 1: åŸºç¡€è®¾æ–½éªŒè¯ï¼ˆæ‰‹åŠ¨ï¼‰

```bash
cd /Users/pengzai/www/morphicai/deploy-webhook/backend

# 1. æ¸…ç©ºæµ‹è¯•æ•°æ®åº“
rm -f data/test/deploy-webhook.db*

# 2. é‡æ–°æ„å»º
npm run build

# 3. éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
node -e "
const { getDb } = require('./dist/services/database');
const db = getDb();
const tables = db.prepare('SELECT name FROM sqlite_master WHERE type=\"table\" ORDER BY name').all();
console.log('ğŸ“Š æ•°æ®åº“è¡¨:', tables.map(t => t.name));

// éªŒè¯å…³é”®è¡¨
const requiredTables = ['secret_groups', 'secrets', 'environment_variables', 'applications', 'deployment_logs'];
requiredTables.forEach(table => {
  const exists = tables.some(t => t.name === table);
  console.log(exists ? 'âœ…' : 'âŒ', table);
});
"
```

### Step 2: åˆ†å±‚æµ‹è¯•æ‰§è¡Œ

#### ç¬¬ 1 è½®ï¼šè®¤è¯å±‚
```bash
npm test -- auth.test.ts --verbose
```
**é¢„æœŸï¼š** å…¨éƒ¨é€šè¿‡ âœ…

#### ç¬¬ 2 è½®ï¼šç§˜é’¥ç®¡ç†ï¼ˆåˆ†æ®µï¼‰
```bash
# 2.1 Secret Groups
npm test -- secrets.test.ts -t "Secret Groups" --verbose

# 2.2 Secrets Management
npm test -- secrets.test.ts -t "Secrets Management" --verbose

# 2.3 Environment Variables (åŸºç¡€)
npm test -- secrets.test.ts -t "Environment Variables" --verbose

# 2.4 Secret References (V2 æ–°åŠŸèƒ½)
npm test -- secrets.test.ts -t "Secret References" --verbose
```

#### ç¬¬ 3 è½®ï¼šéƒ¨ç½²æ—¥å¿—
```bash
npm test -- deploymentLogs.test.ts --verbose
```

#### ç¬¬ 4 è½®ï¼šéƒ¨ç½²åŠŸèƒ½
```bash
# 4.1 åº”ç”¨ç®¡ç†
npm test -- deploy.test.ts -t "Application" --verbose

# 4.2 éƒ¨ç½²åŠŸèƒ½
npm test -- deploy.test.ts -t "Deploy" --verbose

# 4.3 Webhook éƒ¨ç½²
npm test -- deploy.test.ts -t "Webhook" --verbose
```

### Step 3: å®Œæ•´å›å½’æµ‹è¯•
```bash
npm test --verbose
```

---

## ğŸ”§ ä¿®å¤ç­–ç•¥

### ä¼˜å…ˆçº§ 1ï¼ˆé˜»å¡æ€§é—®é¢˜ï¼‰

1. **ç¯å¢ƒå˜é‡ API è·¯ç”±é—®é¢˜**
   - é—®é¢˜ï¼šæ›´æ–°/åˆ é™¤è¿”å› 404
   - æ–‡ä»¶ï¼š`backend/src/routes/envVars.ts`
   - ä¿®å¤ï¼šæ£€æŸ¥è·¯ç”±å®šä¹‰å’Œå‚æ•°è§£æ

2. **Secret åˆ›å»ºè¿”å›æ•°æ®ç»“æ„**
   - é—®é¢˜ï¼š`secretResponse.body.data.id` æœªå®šä¹‰
   - æ–‡ä»¶ï¼š`backend/src/routes/secrets.ts`
   - ä¿®å¤ï¼šç¡®ä¿è¿”å›æ ¼å¼ä¸º `{ success: true, data: { id, ... } }`

3. **ç¯å¢ƒå˜é‡ Upsert é€»è¾‘**
   - é—®é¢˜ï¼šæœŸæœ› 201ï¼Œå®é™…è¿”å› 200
   - æ–‡ä»¶ï¼š`backend/src/services/envStore.ts`
   - ä¿®å¤ï¼šåŒºåˆ†åˆ›å»ºå’Œæ›´æ–°çš„è¿”å›çŠ¶æ€ç 

### ä¼˜å…ˆçº§ 2ï¼ˆåŠŸèƒ½é—®é¢˜ï¼‰

4. **Secret References è§£æ**
   - é—®é¢˜ï¼šç¯å¢ƒå˜é‡å¼•ç”¨ç§˜é’¥åŠŸèƒ½
   - æ–‡ä»¶ï¼š`backend/src/services/envStore.ts`
   - ä¿®å¤ï¼šå®ç° `buildEnvironmentForProject` è§£æç§˜é’¥å¼•ç”¨

5. **ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§**
   - é—®é¢˜ï¼šé¡¹ç›®çº§åˆ«ç¯å¢ƒå˜é‡æœªæ­£ç¡®è¦†ç›–å…¨å±€å˜é‡
   - æ–‡ä»¶ï¼š`backend/src/services/envStore.ts`
   - ä¿®å¤ï¼šç¡®ä¿é¡¹ç›®çº§åˆ«ä¼˜å…ˆçº§é«˜äºå…¨å±€

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | å½“å‰ | ç›®æ ‡ | ä¼˜å…ˆçº§ |
|-----|------|------|--------|
| è®¤è¯å±‚ | âœ… 100% | 100% | é«˜ |
| Secret Groups | âŒ 0% | 100% | é«˜ |
| Secrets | âš ï¸ 60% | 100% | é«˜ |
| Environment Variables | âš ï¸ 40% | 100% | é«˜ |
| Deployment Logs | âŒ 0% | 90% | ä¸­ |
| Application Management | âš ï¸ 70% | 100% | é«˜ |
| Deployment | âš ï¸ 50% | 90% | é«˜ |
| Webhook Deploy | âŒ 0% | 100% | é«˜ |

---

## ğŸ¯ ä»Šæ—¥æµ‹è¯•ç›®æ ‡

### æœ€å°ç›®æ ‡ï¼ˆ2 å°æ—¶ï¼‰
- âœ… æ¸…ç†æ‰€æœ‰è¿ç§»è„šæœ¬
- âœ… éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
- âœ… è®¤è¯å±‚æµ‹è¯•é€šè¿‡
- â³ Secret Groups æµ‹è¯•é€šè¿‡

### ç†æƒ³ç›®æ ‡ï¼ˆ4 å°æ—¶ï¼‰
- âœ… æ¸…ç†æ‰€æœ‰è¿ç§»è„šæœ¬
- âœ… éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
- âœ… è®¤è¯å±‚æµ‹è¯•é€šè¿‡
- âœ… Secret Groups + Secrets æµ‹è¯•é€šè¿‡
- âœ… Environment Variables åŸºç¡€åŠŸèƒ½é€šè¿‡

### å®Œç¾ç›®æ ‡ï¼ˆ6 å°æ—¶ï¼‰
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… V2 åŠŸèƒ½å®Œæ•´è¦†ç›–
- âœ… æ–‡æ¡£æ›´æ–°å®Œæˆ

---

## ğŸ’¡ æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•ä¼˜å…ˆ
å¯¹äºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ç§˜é’¥å¼•ç”¨è§£æï¼‰ï¼Œå»ºè®®å…ˆå†™å•å…ƒæµ‹è¯•ã€‚

### 2. éš”ç¦»æµ‹è¯•
æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„æ‰§è¡Œé¡ºåºã€‚

### 3. æ•°æ®æ¸…ç†
æ¯ä¸ªæµ‹è¯•å‰åéƒ½è¦æ¸…ç†æ•°æ®åº“ï¼Œé¿å…æµ‹è¯•æ±¡æŸ“ã€‚

### 4. é”™è¯¯å¤„ç†
æµ‹è¯•ä¸ä»…è¦è¦†ç›–æˆåŠŸåœºæ™¯ï¼Œè¿˜è¦è¦†ç›–å„ç§é”™è¯¯åœºæ™¯ã€‚

### 5. æ€§èƒ½æµ‹è¯•
å¯¹äºéƒ¨ç½²ç­‰è€—æ—¶æ“ä½œï¼Œå¯ä»¥è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [V2 æ•°æ®æ¨¡å‹è®¾è®¡](./DATA_MODEL_V2_DESIGN.md)
- [V2 å·¥ä½œæµç¨‹](./DATA_MODEL_V2_WORKFLOW.md)
- [V2 å®ç°çŠ¶æ€](./IMPLEMENTATION_STATUS.md)
- [V2 æ¸…ç†å®Œæˆ](./CLEANUP_V2_COMPLETE.md)

---

**æœ€åæ›´æ–°ï¼š** 2025-10-23  
**çŠ¶æ€ï¼š** ğŸ”´ æµ‹è¯•ä¸­ï¼ˆ40 å¤±è´¥ï¼Œ31 é€šè¿‡ï¼‰  
**ä¸‹ä¸€æ­¥ï¼š** ä»è®¤è¯å±‚å¼€å§‹ï¼Œé€å±‚æµ‹è¯•ä¿®å¤

